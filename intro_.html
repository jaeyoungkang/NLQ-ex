<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLQ to BigQuery 분석 서비스 메커니즘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/flowbite.min.css" rel="stylesheet" />
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .flow-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .flow-chart-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 600px;
            min-height: 120px;
            position: relative;
        }
        .flow-arrow {
            font-size: 2rem;
            color: #9ca3af;
            margin: 0.5rem 0;
        }
        .tech-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.75rem;
        }
        .section-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .step-explanation {
            border-left: 4px solid #4f46e5;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
        .code-snippet {
            display: block;
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">

        <header class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">자연어 - 빅쿼리 조회 및 분석 서비스 소개</h1>
            <p class="text-lg text-gray-600">LLM을 활용하여 SQL을 생성하여 BigQuery를 조회, 조회된 데이터를 다시 LLM으로 분석</p>
        </header>

        <!-- 1. 플로우 차트 -->
        <section class="mb-12">
            <h2 class="section-title">서비스 작동 플로우</h2>
            <div class="flow-chart-container">
                <!-- Step 1: User Input -->
                <div class="flow-chart-item bg-indigo-50 border border-indigo-200">
                    <div class="text-2xl mb-2">👤</div>
                    <h3 class="text-lg font-semibold text-indigo-800">1. 사용자 질문 입력</h3>
                    <p class="text-sm text-indigo-700">웹 인터페이스(HTML)에서 자연어로 질문을 입력합니다.</p>
                    <span class="tech-badge bg-indigo-200 text-indigo-800">Frontend (HTML, JS)</span>
                </div>
                <div class="flow-arrow">⬇️</div>

                <!-- Step 2: Backend Request -->
                <div class="flow-chart-item bg-gray-50 border border-gray-200">
                    <div class="text-2xl mb-2">🖥️</div>
                    <h3 class="text-lg font-semibold text-gray-800">2. 백엔드 API 요청</h3>
                    <p class="text-sm text-gray-700">JavaScript가 사용자의 질문을 Flask 백엔드 서버로 전송합니다.</p>
                    <span class="tech-badge bg-gray-200 text-gray-800">Backend (Flask)</span>
                </div>
                <div class="flow-arrow">⬇️</div>

                <!-- Step 3: NLQ to SQL -->
                <div class="flow-chart-item bg-purple-50 border border-purple-200">
                    <div class="text-2xl mb-2">🤖</div>
                    <h3 class="text-lg font-semibold text-purple-800">3. 자연어 ➡️ SQL 변환</h3>
                    <p class="text-sm text-purple-700">Flask 서버가 Anthropic Claude 3.5 Sonnet 모델을 호출하여 자연어 질문을 BigQuery SQL로 변환합니다.</p>
                    <span class="tech-badge bg-purple-200 text-purple-800">AI (Claude 3.5)</span>
                </div>
                <div class="flow-arrow">⬇️</div>

                <!-- Step 4: Execute Query -->
                <div class="flow-chart-item bg-blue-50 border border-blue-200">
                    <div class="text-2xl mb-2">🗃️</div>
                    <h3 class="text-lg font-semibold text-blue-800">4. BigQuery 쿼리 실행</h3>
                    <p class="text-sm text-blue-700">생성된 SQL을 Google BigQuery에서 실행하여 데이터를 조회합니다.</p>
                    <span class="tech-badge bg-blue-200 text-blue-800">Database (BigQuery)</span>
                </div>
                <div class="flow-arrow">⬇️</div>

                <!-- Step 5: Process & Analyze -->
                <div class="flow-chart-item bg-green-50 border border-green-200">
                    <div class="text-2xl mb-2">💡</div>
                    <h3 class="text-lg font-semibold text-green-800">5. 결과 분석 및 시각화 생성</h3>
                    <p class="text-sm text-green-700">조회된 데이터를 다시 Claude 모델에 전달하여 분석 리포트, 인사이트, 차트 설정, 또는 완전한 HTML 문서를 생성합니다.</p>
                    <span class="tech-badge bg-green-200 text-green-800">AI (Claude 3.5) & Backend (Python)</span>
                </div>
                <div class="flow-arrow">⬇️</div>

                <!-- Step 6: Display Results -->
                <div class="flow-chart-item bg-yellow-50 border border-yellow-200">
                    <div class="text-2xl mb-2">📈</div>
                    <h3 class="text-lg font-semibold text-yellow-800">6. 최종 결과 표시</h3>
                    <p class="text-sm text-yellow-700">백엔드가 처리된 최종 결과를 프론트엔드로 전송하고, JavaScript가 이를 동적으로 화면에 렌더링합니다. (데이터 테이블, 차트, 분석 리포트 등)</p>
                    <span class="tech-badge bg-yellow-200 text-yellow-800">Frontend (JS, Chart.js)</span>
                </div>
            </div>
        </section>

        <!-- 2. 단계별 상세 설명 -->
        <section class="mb-12">
            <h2 class="section-title">단계별 상세 설명</h2>
            
            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">1. 사용자 질문 입력 (Frontend)</h3>
                <p>사용자는 웹 브라우저에 표시된 UI (`index.html`)의 텍스트 입력창에 "가장 많이 발생한 이벤트는?"과 같은 자연어 질문을 입력합니다. 예시 질문을 클릭하여 입력할 수도 있습니다.</p>
                <code class="code-snippet text-sm">// static/js/main.js
quickBtn.addEventListener('click', () => executeQuery('quick'));
structuredBtn.addEventListener('click', () => executeQuery('structured'));
creativeBtn.addEventListener('click', () => executeQuery('creative'));</code>
            </div>

            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">2. 백엔드 API 요청 (Flask)</h3>
                <p>사용자가 분석 모드 버튼(빠른 조회, 구조화 분석, 창의적 HTML) 중 하나를 클릭하면, `main.js`의 `executeQuery` 함수가 실행됩니다. 이 함수는 선택된 모드와 질문 내용을 담아 Flask 백엔드의 해당 API 엔드포인트(`/quick`, `/analyze`, `/creative-html`)로 POST 요청을 보냅니다.</p>
                <code class="code-snippet text-sm"># app.py
@app.route('/analyze', methods=['POST'])
def structured_analysis():
    question = request.json['question'].strip()
    # ... (후략)</code>
            </div>

            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">3. 자연어 ➡️ SQL 변환 (Claude 3.5)</h3>
                <p>Flask 백엔드는 `natural_language_to_sql` 함수를 호출합니다. 이 함수는 사전에 정의된 시스템 프롬프트(테이블 스키마 정보, SQL 생성 규칙 등)와 사용자의 질문을 함께 Anthropic Claude 3.5 Sonnet 모델로 전달합니다. 모델은 이 정보를 바탕으로 BigQuery에서 실행 가능한 표준 SQL 쿼리를 생성하여 반환합니다.</p>
                 <code class="code-snippet text-sm"># app.py - natural_language_to_sql(question)
system_prompt = get_sql_generation_system_prompt()
response = anthropic_client.messages.create(
    model="claude-3-5-sonnet-20241022",
    system=system_prompt,
    messages=[{"role": "user", "content": question}]
)
sql_query = response.content[0].text.strip()
return sql_query</code>
            </div>

            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">4. BigQuery 쿼리 실행 (Database)</h3>
                <p>`execute_bigquery` 함수가 생성된 SQL 쿼리를 Google Cloud의 BigQuery 서비스로 전달하여 실행합니다. BigQuery는 대용량 데이터를 빠르게 처리하고 그 결과를 Python 객체 형태로 반환합니다.</p>
                 <code class="code-snippet text-sm"># app.py - execute_bigquery(sql_query)
query_job = bigquery_client.query(sql_query)
results = query_job.result() # 쿼리 실행 및 결과 가져오기
rows = [dict(row) for row in results] # 결과를 딕셔너리 리스트로 변환
return {"success": True, "data": rows}</code>
            </div>

            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">5. 결과 분석 및 시각화 생성 (Claude 3.5 & Python)</h3>
                <p>이 단계는 사용자가 선택한 모드에 따라 다르게 동작합니다.</p>
                <ul class="list-disc list-inside mt-2 space-y-2">
                    <li><strong>빠른 조회:</strong> 이 단계를 건너뛰고 조회된 데이터를 바로 다음 단계로 넘깁니다.</li>
                    <li><strong>구조화 분석:</strong> `generate_analysis_report` 함수가 호출됩니다. 조회된 데이터의 샘플과 통계 정보를 Claude 모델에 전달하여 텍스트 기반의 분석 리포트를 생성하고, `suggest_chart_config` 함수가 데이터 구조를 분석해 적절한 차트(막대, 선 등) 설정을 제안합니다.</li>
                    <li><strong>창의적 HTML:</strong> `generate_html_analysis_report` 함수가 호출됩니다. 데이터 샘플, 질문, SQL 쿼리 등을 포함한 상세한 프롬프트를 Claude 모델에 전달하여 분석 내용, 차트(Chart.js), 스타일(CSS)이 모두 포함된 완전한 단일 HTML 문서를 생성하도록 요청합니다.</li>
                </ul>
            </div>

            <div class="step-explanation">
                <h3 class="text-xl font-semibold mb-2">6. 최종 결과 표시 (Frontend)</h3>
                <p>Flask 백엔드는 처리된 최종 결과(JSON 형식)를 프론트엔드로 응답합니다. `main.js`와 `analysis.js`의 JavaScript 코드가 이 응답을 받아 동적으로 HTML 요소를 생성합니다. `displayQuickResults`, `displayStructuredResults`, `displayCreativeHtmlResults` 함수들이 각각의 모드에 맞는 UI를 렌더링하며, 필요한 경우 Chart.js를 사용해 데이터를 시각화합니다.</p>
                 <code class="code-snippet text-sm">// static/js/analysis.js - displayStructuredResults(data)
document.getElementById('resultsSection').innerHTML = resultHtml;
if (data.chart_config) {
    createChart(data.data, data.chart_config);
}</code>
            </div>
        </section>

        <!-- 3. 기술 스택 -->
        <section>
            <h2 class="section-title">사용된 기술 스택</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Frontend</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li><strong>HTML5:</strong> 웹 페이지의 기본 구조</li>
                        <li><strong>Tailwind CSS:</strong> 빠르고 유연한 UI 개발을 위한 CSS 프레임워크</li>
                        <li><strong>JavaScript (ES6+):</strong> 비동기 통신(Fetch API) 및 동적 UI 렌더링</li>
                        <li><strong>Chart.js:</strong> 데이터 시각화를 위한 JavaScript 라이브러리</li>
                    </ul>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Backend</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li><strong>Python 3.11:</strong> 주력 개발 언어</li>
                        <li><strong>Flask:</strong> API 서버 구축을 위한 경량 웹 프레임워크</li>
                        <li><strong>Gunicorn:</strong> 프로덕션 환경을 위한 WSGI HTTP 서버</li>
                    </ul>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">AI / ML</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li><strong>Anthropic Claude 3.5 Sonnet:</strong> 자연어-SQL 변환, 데이터 분석, 리포트 및 HTML 생성 등 핵심적인 AI 기능을 수행하는 대규모 언어 모델(LLM)</li>
                    </ul>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Database & Cloud</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li><strong>Google BigQuery:</strong> 대규모 데이터 분석을 위한 서버리스 데이터 웨어하우스</li>
                        <li><strong>Google Cloud Run:</strong> 컨테이너화된 애플리케이션을 배포하고 확장하기 위한 서버리스 플랫폼</li>
                        <li><strong>Google Secret Manager:</strong> API 키 등 민감한 정보를 안전하게 저장</li>
                    </ul>
                </div>
            </div>
        </section>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/flowbite.min.js"></script>
</body>
</html>
