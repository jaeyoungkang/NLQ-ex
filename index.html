<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 데이터 자연어 질의 & 분석</title>
    <!-- Chart.js 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .query-section {
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        #questionInput {
            width: 100%;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #questionInput:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        #questionInput::placeholder {
            color: #999;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .btn-quick {
            background: linear-gradient(135deg, #34a853 0%, #67b566 100%);
            color: white;
        }

        .btn-structured {
            background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%);
            color: white;
        }

        .btn-creative {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-description {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .mode-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }

        .mode-selector h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .mode-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .mode-card:hover {
            border-color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.15);
        }

        .mode-card.selected {
            border-color: #4285f4;
            background: #f8f9fa;
        }

        .mode-card h4 {
            color: #4285f4;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .mode-card p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .mode-features {
            list-style: none;
            margin-top: 10px;
        }

        .mode-features li {
            color: #28a745;
            font-size: 0.8rem;
            margin: 2px 0;
        }

        .mode-features li:before {
            content: "✓ ";
            font-weight: bold;
        }

        .example-questions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }

        .example-questions h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .example-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e1e5e9;
        }

        .example-item:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            transform: translateY(-1px);
        }

        .example-item code {
            color: #1a73e8;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-title {
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #666;
            margin-top: 15px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .results-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .result-count {
            background: #4285f4;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .mode-badge {
            background: #34a853;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
        }

        .mode-badge.structured {
            background: #4285f4;
        }

        .mode-badge.creative {
            background: #ff6b6b;
        }

        .results-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #4285f4;
            border-bottom-color: #4285f4;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .query-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }

        .query-info h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }

        .original-question {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-style: italic;
            color: #1a73e8;
        }

        .generated-sql {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .data-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #34a853;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            text-align: center;
        }

        .summary-card h4 {
            color: #4285f4;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .summary-card .label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .insights-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .insights-list ul {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        #analysisChart {
            max-height: 400px;
        }

        .analysis-report {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #ff6b6b;
            line-height: 1.6;
        }

        .analysis-report h1,
        .analysis-report h2,
        .analysis-report h3 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        .analysis-report h1 {
            font-size: 1.4rem;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 5px;
        }

        .analysis-report h2 {
            font-size: 1.2rem;
            color: #ff6b6b;
        }

        .analysis-report ul {
            margin: 10px 0 10px 20px;
        }

        .analysis-report li {
            margin: 5px 0;
        }

        .analysis-report strong {
            color: #2c5282;
        }

        .analysis-report code {
            background: #e2e8f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .html-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .iframe-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .html-warning {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
            font-size: 0.9rem;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e1e5e9;
            color: #333;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e8f0fe;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #fce8e6;
            border: 1px solid #ea4335;
            color: #d93025;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .error h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #34a853;
            color: #137333;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .info-badge {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-left: 3px solid #4285f4;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 30px 20px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .mode-grid {
                grid-template-columns: 1fr;
            }

            .example-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 500px;
            }

            .results-tabs {
                flex-wrap: wrap;
            }

            .html-controls {
                flex-direction: column;
            }
            
            .iframe-container iframe {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 GA4 데이터 자연어 질의 & 분석</h1>
            <p>Google Analytics 4 이벤트 데이터를 자연어로 질문하고 3가지 방식으로 분석해보세요</p>
        </div>

        <div class="main-content">
            <!-- 데이터 정보 -->
            <div class="info-badge">
                📅 <strong>데이터 범위:</strong> 2020년 11월 21일 GA4 이벤트 데이터 | 
                🏢 <strong>데이터 소스:</strong> nlq-ex.test_dataset.events_20201121 |
                🎯 <strong>지원 모드:</strong> 빠른 조회 / 구조화 분석 / 창의적 HTML
            </div>

            <!-- 분석 모드 선택 -->
            <div class="mode-selector">
                <h3>🎛️ 분석 모드 선택</h3>
                <div class="mode-grid">
                    <div class="mode-card" data-mode="quick">
                        <h4>⚡ 빠른 조회</h4>
                        <p>SQL 쿼리 실행 후 데이터만 빠르게 확인</p>
                        <ul class="mode-features">
                            <li>즉시 결과 표시</li>
                            <li>테이블 형태 데이터</li>
                            <li>간단한 분석용</li>
                        </ul>
                    </div>
                    <div class="mode-card selected" data-mode="structured">
                        <h4>📊 구조화 분석</h4>
                        <p>데이터 + 차트 + AI 분석 리포트 통합 제공</p>
                        <ul class="mode-features">
                            <li>자동 차트 생성</li>
                            <li>Claude Console 스타일 리포트</li>
                            <li>비즈니스 인사이트</li>
                            <li>데이터 요약 카드</li>
                        </ul>
                    </div>
                    <div class="mode-card" data-mode="creative">
                        <h4>🎨 창의적 HTML</h4>
                        <p>Claude가 완전한 HTML 리포트 생성 (실험적)</p>
                        <ul class="mode-features">
                            <li>완전한 독립 문서</li>
                            <li>창의적인 디자인</li>
                            <li>다운로드 가능</li>
                            <li>프레젠테이션용</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 예시 질문들 -->
            <div class="example-questions">
                <h3>💡 예시 질문들 (클릭하면 자동 입력됩니다)</h3>
                
                <div class="category-section">
                    <div class="category-title">🔢 기본 집계 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('총 이벤트 수를 알려주세요')">
                            <code>"총 이벤트 수를 알려주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('가장 많이 발생한 이벤트 유형 상위 10개를 보여주세요')">
                            <code>"가장 많이 발생한 이벤트 유형 상위 10개를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('고유 사용자 수를 알려주세요')">
                            <code>"고유 사용자 수를 알려주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🌍 지역별 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('국가별 사용자 수를 보여주세요')">
                            <code>"국가별 사용자 수를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('도시별 이벤트 수 상위 10개를 보여주세요')">
                            <code>"도시별 이벤트 수 상위 10개를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('미국 사용자들의 이벤트 수를 알려주세요')">
                            <code>"미국 사용자들의 이벤트 수를 알려주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">📱 기기 및 플랫폼 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('모바일과 데스크톱 사용자 비율을 보여주세요')">
                            <code>"모바일과 데스크톱 사용자 비율을 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('운영체제별 사용자 분포를 보여주세요')">
                            <code>"운영체제별 사용자 분포를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('플랫폼별 이벤트 수를 보여주세요')">
                            <code>"플랫폼별 이벤트 수를 보여주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🕐 시간대별 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('시간대별 이벤트 수를 보여주세요')">
                            <code>"시간대별 이벤트 수를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('page_view 이벤트가 가장 많은 시간대를 보여주세요')">
                            <code>"page_view 이벤트가 가장 많은 시간대를 보여주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🛒 전자상거래 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('purchase 이벤트의 총 매출을 보여주세요')">
                            <code>"purchase 이벤트의 총 매출을 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('구매 이벤트 수를 알려주세요')">
                            <code>"구매 이벤트 수를 알려주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('add_to_cart 이벤트가 많은 상위 10개 사용자를 보여주세요')">
                            <code>"add_to_cart 이벤트가 많은 상위 10개 사용자를 보여주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🔗 트래픽 소스 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('트래픽 소스별 이벤트 수를 보여주세요')">
                            <code>"트래픽 소스별 이벤트 수를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('트래픽 매체별 사용자 수를 보여주세요')">
                            <code>"트래픽 매체별 사용자 수를 보여주세요"</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 질문 입력 섹션 -->
            <div class="query-section">
                <div class="input-group">
                    <label for="questionInput">질문을 입력하세요</label>
                    <textarea 
                        id="questionInput" 
                        placeholder="예: 한국 사용자들의 page_view 이벤트 수를 알려주세요"
                        rows="4"
                    ></textarea>
                </div>

                <div class="button-group">
                    <button id="quickBtn" class="btn btn-quick">
                        ⚡ 빠른 조회
                        <div class="btn-description">데이터만 빠르게</div>
                    </button>
                    <button id="structuredBtn" class="btn btn-structured">
                        📊 구조화 분석
                        <div class="btn-description">차트 + 리포트</div>
                    </button>
                    <button id="creativeBtn" class="btn btn-creative">
                        🎨 창의적 HTML
                        <div class="btn-description">독립 문서 생성</div>
                    </button>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <span id="loadingText">데이터를 조회하고 있습니다...</span>
                    </div>
                </div>
            </div>

            <!-- 결과 섹션 -->
            <div class="results-section" id="resultsSection">
                <!-- 결과가 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        const questionInput = document.getElementById('questionInput');
        const quickBtn = document.getElementById('quickBtn');
        const structuredBtn = document.getElementById('structuredBtn');
        const creativeBtn = document.getElementById('creativeBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const resultsSection = document.getElementById('resultsSection');

        let currentChart = null;
        let selectedMode = 'structured';

        // 모드 선택 카드 이벤트
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                // 기존 선택 제거
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                // 새 선택 추가
                this.classList.add('selected');
                selectedMode = this.dataset.mode;
            });
        });

        // 예시 질문 설정 함수
        function setQuestion(question) {
            questionInput.value = question;
            questionInput.focus();
        }

        // Enter 키로 질문 전송 (Ctrl+Enter)
        questionInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery(selectedMode);
            }
        });

        // 버튼 이벤트들
        quickBtn.addEventListener('click', () => executeQuery('quick'));
        structuredBtn.addEventListener('click', () => executeQuery('structured'));
        creativeBtn.addEventListener('click', () => executeQuery('creative'));

        // 질문 실행 함수
        async function executeQuery(mode) {
            const question = questionInput.value.trim();

            if (!question) {
                alert('질문을 입력해주세요.');
                questionInput.focus();
                return;
            }

            // UI 상태 변경
            setLoadingState(true, mode);

            try {
                // 모드별 엔드포인트 결정
                const endpoints = {
                    'quick': '/quick',
                    'structured': '/analyze',
                    'creative': '/creative-html'
                };

                const response = await fetch(endpoints[mode], {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayResults(data, mode);
                } else {
                    displayError(data.error || '알 수 없는 오류가 발생했습니다.', mode);
                }
            } catch (error) {
                console.error('API 호출 오류:', error);
                displayError(`네트워크 오류: ${error.message}`, mode);
            } finally {
                setLoadingState(false);
            }
        }

        // 로딩 상태 설정
        function setLoadingState(isLoading, mode = '') {
            quickBtn.disabled = isLoading;
            structuredBtn.disabled = isLoading;
            creativeBtn.disabled = isLoading;
            loading.style.display = isLoading ? 'flex' : 'none';
            
            if (isLoading) {
                const messages = {
                    'quick': '빠르게 데이터를 조회하고 있습니다...',
                    'structured': 'AI가 데이터를 분석하고 차트를 생성하고 있습니다...',
                    'creative': 'Claude가 창의적인 HTML 리포트를 생성하고 있습니다... (30초 소요)'
                };
                loadingText.textContent = messages[mode] || '데이터를 처리하고 있습니다...';
                
                const btnTexts = {
                    'quick': '⏳ 조회 중...',
                    'structured': '⏳ 분석 중...',
                    'creative': '⏳ 생성 중...'
                };
                quickBtn.innerHTML = btnTexts['quick'];
                structuredBtn.innerHTML = btnTexts['structured'];
                creativeBtn.innerHTML = btnTexts['creative'];
            } else {
                quickBtn.innerHTML = '⚡ 빠른 조회<div class="btn-description">데이터만 빠르게</div>';
                structuredBtn.innerHTML = '📊 구조화 분석<div class="btn-description">차트 + 리포트</div>';
                creativeBtn.innerHTML = '🎨 창의적 HTML<div class="btn-description">독립 문서 생성</div>';
            }
        }

        // 결과 표시 (모드별 분기)
        function displayResults(data, mode) {
            if (mode === 'creative') {
                displayCreativeHtmlResults(data);
            } else if (mode === 'structured') {
                displayStructuredResults(data);
            } else {
                displayQuickResults(data);
            }
        }

        // 빠른 조회 결과 표시
        function displayQuickResults(data) {
            const resultHtml = `
                <div class="results-header">
                    <h2>⚡ 빠른 조회 결과 <span class="mode-badge quick">QUICK</span></h2>
                    <div class="result-count">${data.row_count}개 결과</div>
                </div>

                <div class="query-info">
                    <h3>📝 쿼리 정보</h3>
                    <div class="original-question">
                        <strong>원본 질문:</strong> ${escapeHtml(data.original_question)}
                    </div>
                    <div class="generated-sql">
                        <strong>생성된 SQL:</strong><br>
                        ${escapeHtml(data.generated_sql)}
                    </div>
                </div>

                <div class="table-container">
                    ${createTable(data.data)}
                </div>

                <div class="success">
                    <h3>✅ 조회 완료</h3>
                    <p>총 ${data.row_count}개의 결과를 빠르게 조회했습니다.</p>
                    <p>💡 더 자세한 분석을 원하시면 "구조화 분석" 모드를 사용해보세요.</p>
                </div>
            `;

            resultsSection.innerHTML = resultHtml;
        }

        // 구조화된 분석 결과 표시
        function displayStructuredResults(data) {
            let tabsHtml = `
                <div class="results-tabs">
                    <button class="tab-button active" onclick="showTab('data')">📊 데이터</button>
                    <button class="tab-button" onclick="showTab('query')">📝 쿼리 정보</button>
                    <button class="tab-button" onclick="showTab('analysis')">🤖 AI 분석</button>
                </div>
            `;

            let resultHtml = `
                <div class="results-header">
                    <h2>📊 구조화 분석 결과 <span class="mode-badge structured">STRUCTURED</span></h2>
                    <div class="result-count">${data.row_count}개 결과</div>
                </div>

                ${tabsHtml}

                <div class="tab-content active" id="tab-data">
                    <div class="table-container">
                        ${createTable(data.data)}
                    </div>
                </div>

                <div class="tab-content" id="tab-query">
                    <div class="query-info">
                        <h3>📝 질문 정보</h3>
                        <div class="original-question">
                            <strong>원본 질문:</strong> ${escapeHtml(data.original_question)}
                        </div>
                        <div class="generated-sql">
                            <strong>생성된 SQL:</strong><br>
                            ${escapeHtml(data.generated_sql)}
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-analysis">
                    ${data.data_summary ? `
                    <div class="data-summary">
                        <h3>📊 데이터 개요</h3>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h4>총 레코드</h4>
                                <div class="value">${data.data_summary.overview.total_rows.toLocaleString()}</div>
                                <div class="label">개</div>
                            </div>
                            <div class="summary-card">
                                <h4>컬럼 수</h4>
                                <div class="value">${data.data_summary.overview.columns_count}</div>
                                <div class="label">개</div>
                            </div>
                            <div class="summary-card">
                                <h4>데이터 타입</h4>
                                <div class="value">${Object.values(data.data_summary.overview.data_types).filter(type => type === 'numeric').length}</div>
                                <div class="label">숫자형</div>
                            </div>
                            <div class="summary-card">
                                <h4>카테고리형</h4>
                                <div class="value">${Object.values(data.data_summary.overview.data_types).filter(type => type === 'categorical').length}</div>
                                <div class="label">개</div>
                            </div>
                        </div>
                        ${data.data_summary.quick_insights && data.data_summary.quick_insights.length > 0 ? `
                        <div class="insights-list">
                            <h4>🎯 빠른 인사이트</h4>
                            <ul>
                                ${data.data_summary.quick_insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    ${data.chart_config ? `
                    <div class="chart-container">
                        <h4>${data.chart_config.title || '데이터 시각화'}</h4>
                        <div class="chart-wrapper">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>
                    ` : ''}
                    <div class="analysis-report">
                        ${parseMarkdown(data.analysis_report)}
                    </div>
                </div>

                <div class="success">
                    <h3>✅ 분석 완료</h3>
                    <p>총 ${data.row_count}개의 결과를 성공적으로 분석했습니다.</p>
                    <p>🤖 AI 분석 리포트와 차트를 "AI 분석" 탭에서 확인하세요.</p>
                </div>
            `;

            resultsSection.innerHTML = resultHtml;
            
            // 차트 생성
            if (data.chart_config) {
                setTimeout(() => createChart(data.data, data.chart_config), 100);
            }
        }

        // 창의적 HTML 결과 표시
        function displayCreativeHtmlResults(data) {
            const qualityBadge = data.quality_score >= 80 ? 
                `<span style="background: #34a853; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">고품질</span>` :
                data.quality_score >= 60 ?
                `<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">양호</span>` :
                `<span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">기본</span>`;

            const resultHtml = `
                <div class="results-header">
                    <h2>🎨 창의적 HTML 리포트 <span class="mode-badge creative">CREATIVE</span></h2>
                    <div class="result-count">${data.row_count}개 결과 • ${qualityBadge}</div>
                </div>
                
                <div class="html-controls">
                    <button onclick="openInNewWindow()" class="btn btn-structured">🔗 새 창에서 열기</button>
                    <button onclick="downloadHtml()" class="btn btn-quick">💾 HTML 다운로드</button>
                    ${data.is_fallback ? '<button onclick="regenerateHtml()" class="btn btn-creative">🔄 재생성</button>' : ''}
                </div>
                
                ${data.is_fallback ? `
                <div class="html-warning">
                    ⚠️ <strong>알림:</strong> 고급 HTML 생성에 실패하여 기본 형태로 표시됩니다. 재생성을 시도해보세요.
                </div>
                ` : ''}
                
                <div class="iframe-container">
                    <iframe 
                        id="htmlReportFrame"
                        style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px;"
                        sandbox="allow-scripts allow-same-origin">
                    </iframe>
                </div>
                
                <div class="success">
                    <h3>✅ HTML 리포트 생성 완료</h3>
                    <p>Claude가 ${data.attempts}번의 시도를 통해 독립적인 HTML 리포트를 생성했습니다.</p>
                    <p>품질 점수: ${data.quality_score}/100 | 총 ${data.row_count}개 결과 분석</p>
                </div>
            `;
            
            resultsSection.innerHTML = resultHtml;
            
            // iframe에 HTML 내용 로드
            const iframe = document.getElementById('htmlReportFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(data.html_content);
            doc.close();
            
            // 전역 변수에 HTML 저장
            window.currentHtmlReport = data.html_content;
            window.currentQuestion = data.original_question;
        }

        // 유틸리티 함수들

        // 새 창에서 열기
        function openInNewWindow() {
            if (window.currentHtmlReport) {
                const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
                newWindow.document.write(window.currentHtmlReport);
                newWindow.document.close();
            }
        }

        // HTML 다운로드
        function downloadHtml() {
            if (window.currentHtmlReport) {
                const blob = new Blob([window.currentHtmlReport], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ga4-analysis-${window.currentQuestion?.replace(/[^a-zA-Z0-9]/g, '-') || 'report'}-${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // HTML 재생성
        function regenerateHtml() {
            executeQuery('creative');
        }

        // 탭 전환 함수
        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'analysis' && currentChart) {
                setTimeout(() => currentChart.resize(), 100);
            }
        }

        // 차트 생성 함수
        function createChart(data, config) {
            const canvas = document.getElementById('analysisChart');
            if (!canvas || !data || data.length === 0) return;
            
            // 기존 차트 제거
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            let chartData = {};
            let chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: config.title || '데이터 시각화'
                    }
                }
            };
            
            if (config.type === 'bar' && config.label_column && config.value_column) {
                // 막대 차트
                const labels = data.map(row => String(row[config.label_column]));
                const values = data.map(row => Number(row[config.value_column]) || 0);
                
                chartData = {
                    labels: labels,
                    datasets: [{
                        label: config.value_column,
                        data: values,
                        backgroundColor: [
                            'rgba(66, 133, 244, 0.8)',
                            'rgba(52, 168, 83, 0.8)',
                            'rgba(251, 188, 5, 0.8)',
                            'rgba(234, 67, 53, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(0, 172, 193, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(233, 30, 99, 0.8)',
                            'rgba(121, 85, 72, 0.8)'
                        ],
                        borderColor: [
                            'rgba(66, 133, 244, 1)',
                            'rgba(52, 168, 83, 1)',
                            'rgba(251, 188, 5, 1)',
                            'rgba(234, 67, 53, 1)',
                            'rgba(156, 39, 176, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(0, 172, 193, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(233, 30, 99, 1)',
                            'rgba(121, 85, 72, 1)'
                        ],
                        borderWidth: 1
                    }]
                };
                
                chartOptions.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                };
                
            } else if (config.type === 'line' && config.label_column && config.value_columns) {
                // 선 차트 (다중 데이터)
                const labels = data.map(row => String(row[config.label_column]));
                const datasets = config.value_columns.map((col, index) => {
                    const colors = [
                        'rgba(66, 133, 244, 1)',
                        'rgba(52, 168, 83, 1)',
                        'rgba(251, 188, 5, 1)',
                        'rgba(234, 67, 53, 1)',
                        'rgba(156, 39, 176, 1)'
                    ];
                    
                    return {
                        label: col,
                        data: data.map(row => Number(row[col]) || 0),
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
                        tension: 0.1,
                        fill: false
                    };
                });
                
                chartData = { labels, datasets };
                
                chartOptions.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                };
            }
            
            // 차트 생성
            currentChart = new Chart(ctx, {
                type: config.type,
                data: chartData,
                options: chartOptions
            });
        }

        // 마크다운 파싱 (간단한 버전)
        function parseMarkdown(text) {
            return text
                .replace(/### (.*$)/gim, '<h3>$1</h3>')
                .replace(/## (.*$)/gim, '<h2>$1</h2>')
                .replace(/# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/^(?!<[h|u|l])/gim, '<p>')
                .replace(/(?<![h|u|l]>)$/gim, '</p>');
        }

        // 테이블 생성
        function createTable(data) {
            if (!data || data.length === 0) {
                return '<div class="no-data">조회된 데이터가 없습니다.</div>';
            }

            // 헤더 생성
            const headers = Object.keys(data[0]);
            const headerHtml = headers.map(header => 
                `<th>${escapeHtml(header)}</th>`
            ).join('');

            // 행 생성
            const rowsHtml = data.map(row => {
                const cellsHtml = headers.map(header => {
                    const value = row[header];
                    return `<td>${formatCellValue(value)}</td>`;
                }).join('');
                return `<tr>${cellsHtml}</tr>`;
            }).join('');

            return `
                <table>
                    <thead>
                        <tr>${headerHtml}</tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            `;
        }

        // 셀 값 포맷팅
        function formatCellValue(value) {
            if (value === null || value === undefined) {
                return '<em style="color: #999;">NULL</em>';
            }
            
            if (typeof value === 'number') {
                // 숫자는 천 단위 구분자 추가
                return value.toLocaleString();
            }
            
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                // 날짜 형식 감지 및 포맷팅
                try {
                    const date = new Date(value);
                    return date.toLocaleDateString('ko-KR');
                } catch (e) {
                    return escapeHtml(value);
                }
            }
            
            return escapeHtml(String(value));
        }

        // 오류 표시
        function displayError(errorMessage, mode) {
            const modeLabels = {
                'quick': '빠른 조회',
                'structured': '구조화 분석',
                'creative': '창의적 HTML'
            };

            const errorHtml = `
                <div class="error">
                    <h3>❌ ${modeLabels[mode]} 오류 발생</h3>
                    <p>${escapeHtml(errorMessage)}</p>
                    <p><small>서버 로그를 확인하거나 다른 질문을 시도해보세요.</small></p>
                </div>
            `;

            resultsSection.innerHTML = errorHtml;
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 예시 질문 자동 완성
        const exampleQuestions = [
            "오늘 총 이벤트 수를 알려주세요",
            "가장 인기 있는 이벤트 유형을 보여주세요",
            "국가별 사용자 분포를 보여주세요",
            "모바일 사용자 비율을 알려주세요",
            "시간대별 활동량을 보여주세요",
            "구매 관련 이벤트를 분석해주세요",
            "트래픽 소스별 성과를 보여주세요",
            "운영체제별 사용자 현황을 알려주세요"
        ];

        // 질문 입력창 포커스 시 예시 표시
        questionInput.addEventListener('focus', function() {
            if (!this.value) {
                this.placeholder = exampleQuestions[Math.floor(Math.random() * exampleQuestions.length)];
            }
        });

        // 페이지 로드 시 질문 입력창에 포커스
        window.addEventListener('load', function() {
            questionInput.focus();
        });
    </script>
</body>
</html>