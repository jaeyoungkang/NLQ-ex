<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 데이터 자연어 질의 & 분석</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .query-section {
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        #questionInput {
            width: 100%;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #questionInput:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        #questionInput::placeholder {
            color: #999;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(66, 133, 244, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .analysis-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #4285f4;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        .example-questions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }

        .example-questions h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .example-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e1e5e9;
        }

        .example-item:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            transform: translateY(-1px);
        }

        .example-item code {
            color: #1a73e8;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-title {
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .results-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .result-count {
            background: #4285f4;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .results-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #4285f4;
            border-bottom-color: #4285f4;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .query-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }

        .query-info h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }

        .original-question {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-style: italic;
            color: #1a73e8;
        }

        .generated-sql {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .analysis-report {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #ff6b6b;
            line-height: 1.6;
        }

        .analysis-report h1,
        .analysis-report h2,
        .analysis-report h3 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        .analysis-report h1 {
            font-size: 1.4rem;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 5px;
        }

        .analysis-report h2 {
            font-size: 1.2rem;
            color: #ff6b6b;
        }

        .analysis-report ul {
            margin: 10px 0 10px 20px;
        }

        .analysis-report li {
            margin: 5px 0;
        }

        .analysis-report strong {
            color: #2c5282;
        }

        .analysis-report code {
            background: #e2e8f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e1e5e9;
            color: #333;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e8f0fe;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #fce8e6;
            border: 1px solid #ea4335;
            color: #d93025;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .error h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #34a853;
            color: #137333;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .info-badge {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-left: 3px solid #4285f4;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 30px 20px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .example-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 500px;
            }

            .results-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 GA4 데이터 자연어 질의 & 분석</h1>
            <p>Google Analytics 4 이벤트 데이터를 자연어로 질문하고 AI 분석 리포트를 받아보세요</p>
        </div>

        <div class="main-content">
            <!-- 데이터 정보 -->
            <div class="info-badge">
                📅 <strong>데이터 범위:</strong> 2020년 11월 21일 GA4 이벤트 데이터 | 
                🏢 <strong>데이터 소스:</strong> nlq-ex.test_dataset.events_20201121 |
                🤖 <strong>AI 분석:</strong> Claude를 통한 인사이트 도출
            </div>

            <!-- 예시 질문들 -->
            <div class="example-questions">
                <h3>💡 예시 질문들 (클릭하면 자동 입력됩니다)</h3>
                
                <div class="category-section">
                    <div class="category-title">🔢 기본 집계 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('총 이벤트 수를 알려주세요')">
                            <code>"총 이벤트 수를 알려주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('가장 많이 발생한 이벤트 유형 상위 10개를 보여주세요')">
                            <code>"가장 많이 발생한 이벤트 유형 상위 10개를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('고유 사용자 수를 알려주세요')">
                            <code>"고유 사용자 수를 알려주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🌍 지역별 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('국가별 사용자 수를 보여주세요')">
                            <code>"국가별 사용자 수를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('도시별 이벤트 수 상위 10개를 보여주세요')">
                            <code>"도시별 이벤트 수 상위 10개를 보여주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">📱 기기 및 플랫폼 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('모바일과 데스크톱 사용자 비율을 보여주세요')">
                            <code>"모바일과 데스크톱 사용자 비율을 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('운영체제별 사용자 분포를 보여주세요')">
                            <code>"운영체제별 사용자 분포를 보여주세요"</code>
                        </div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-title">🕐 시간대별 분석</div>
                    <div class="example-grid">
                        <div class="example-item" onclick="setQuestion('시간대별 이벤트 수를 보여주세요')">
                            <code>"시간대별 이벤트 수를 보여주세요"</code>
                        </div>
                        <div class="example-item" onclick="setQuestion('page_view 이벤트가 가장 많은 시간대를 보여주세요')">
                            <code>"page_view 이벤트가 가장 많은 시간대를 보여주세요"</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 질문 입력 섹션 -->
            <div class="query-section">
                <div class="input-group">
                    <label for="questionInput">질문을 입력하세요</label>
                    <textarea 
                        id="questionInput" 
                        placeholder="예: 한국 사용자들의 page_view 이벤트 수를 알려주세요"
                        rows="4"
                    ></textarea>
                </div>

                <div class="analysis-toggle">
                    <div class="toggle-switch" id="analysisToggle">
                        <div class="toggle-slider"></div>
                    </div>
                    <label for="analysisToggle">AI 분석 리포트 포함 (Claude가 데이터를 분석하여 인사이트 제공)</label>
                </div>

                <div class="button-group">
                    <button id="submitBtn" class="btn btn-primary">🔍 질문하기</button>
                    <button id="analyzeBtn" class="btn btn-secondary">📊 분석 리포트</button>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <span id="loadingText">데이터를 조회하고 있습니다...</span>
                    </div>
                </div>
            </div>

            <!-- 결과 섹션 -->
            <div class="results-section" id="resultsSection">
                <!-- 결과가 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        const questionInput = document.getElementById('questionInput');
        const submitBtn = document.getElementById('submitBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const resultsSection = document.getElementById('resultsSection');
        const analysisToggle = document.getElementById('analysisToggle');

        let analysisEnabled = false;

        // 분석 토글 이벤트
        analysisToggle.addEventListener('click', function() {
            analysisEnabled = !analysisEnabled;
            this.classList.toggle('active', analysisEnabled);
        });

        // 예시 질문 설정 함수
        function setQuestion(question) {
            questionInput.value = question;
            questionInput.focus();
        }

        // Enter 키로 질문 전송 (Ctrl+Enter)
        questionInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                submitQuestion(false);
            }
        });

        // 질문하기 버튼 이벤트
        submitBtn.addEventListener('click', () => submitQuestion(false));

        // 분석 리포트 버튼 이벤트
        analyzeBtn.addEventListener('click', () => submitQuestion(true));

        // 질문 전송 함수
        async function submitQuestion(forceAnalysis = false) {
            const question = questionInput.value.trim();

            if (!question) {
                alert('질문을 입력해주세요.');
                questionInput.focus();
                return;
            }

            const includeAnalysis = forceAnalysis || analysisEnabled;

            // UI 상태 변경
            setLoadingState(true, includeAnalysis);

            try {
                const endpoint = includeAnalysis ? '/analyze' : '/query';
                const requestBody = { 
                    question: question,
                    include_analysis: includeAnalysis
                };

                // API 호출 (현재 도메인 사용)
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayResults(data, includeAnalysis);
                } else {
                    displayError(data.error || '알 수 없는 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('API 호출 오류:', error);
                displayError(`네트워크 오류: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        // 로딩 상태 설정
        function setLoadingState(isLoading, isAnalysis = false) {
            submitBtn.disabled = isLoading;
            analyzeBtn.disabled = isLoading;
            loading.style.display = isLoading ? 'flex' : 'none';
            
            if (isLoading) {
                if (isAnalysis) {
                    loadingText.textContent = 'AI가 데이터를 분석하고 있습니다... (30초 정도 소요)';
                    submitBtn.textContent = '분석 중...';
                    analyzeBtn.textContent = '분석 중...';
                } else {
                    loadingText.textContent = '데이터를 조회하고 있습니다...';
                    submitBtn.textContent = '처리 중...';
                }
            } else {
                submitBtn.textContent = '🔍 질문하기';
                analyzeBtn.textContent = '📊 분석 리포트';
            }
        }

        // 결과 표시 (탭 기능 포함)
        function displayResults(data, hasAnalysis = false) {
            let tabsHtml = `
                <div class="results-tabs">
                    <button class="tab-button active" onclick="showTab('data')">📊 데이터</button>
                    <button class="tab-button" onclick="showTab('query')">📝 쿼리 정보</button>
                    ${hasAnalysis && data.analysis_report ? '<button class="tab-button" onclick="showTab(\'analysis\')">🤖 AI 분석</button>' : ''}
                </div>
            `;

            let resultHtml = `
                <div class="results-header">
                    <h2>📊 조회 결과</h2>
                    <div class="result-count">${data.row_count}개 결과</div>
                </div>

                ${tabsHtml}

                <div class="tab-content active" id="tab-data">
                    <div class="table-container">
                        ${createTable(data.data)}
                    </div>
                </div>

                <div class="tab-content" id="tab-query">
                    <div class="query-info">
                        <h3>📝 질문 정보</h3>
                        <div class="original-question">
                            <strong>원본 질문:</strong> ${escapeHtml(data.original_question)}
                        </div>
                        <div class="generated-sql">
                            <strong>생성된 SQL:</strong><br>
                            ${escapeHtml(data.generated_sql)}
                        </div>
                    </div>
                </div>

                ${hasAnalysis && data.analysis_report ? `
                <div class="tab-content" id="tab-analysis">
                    <div class="analysis-report">
                        ${parseMarkdown(data.analysis_report)}
                    </div>
                </div>
                ` : ''}

                <div class="success">
                    <h3>✅ 조회 완료</h3>
                    <p>총 ${data.row_count}개의 결과를 성공적으로 조회했습니다.</p>
                    ${hasAnalysis && data.analysis_report ? '<p>🤖 AI 분석 리포트가 생성되었습니다. "AI 분석" 탭을 확인해보세요.</p>' : ''}
                    ${data.analysis_error ? `<p style="color: #ea4335;">⚠️ 분석 리포트 생성 실패: ${data.analysis_error}</p>` : ''}
                </div>
            `;

            resultsSection.innerHTML = resultHtml;
        }

        // 탭 전환 함수
        function showTab(tabName) {
            // 모든 탭 버튼과 컨텐츠 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // 마크다운 파싱 (간단한 버전)
        function parseMarkdown(text) {
            return text
                .replace(/### (.*$)/gim, '<h3>$1</h3>')
                .replace(/## (.*$)/gim, '<h2>$1</h2>')
                .replace(/# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/^(?!<[h|u|l])/gim, '<p>')
                .replace(/(?<![h|u|l]>)$/gim, '</p>');
        }

        // 테이블 생성
        function createTable(data) {
            if (!data || data.length === 0) {
                return '<div class="no-data">조회된 데이터가 없습니다.</div>';
            }

            // 헤더 생성
            const headers = Object.keys(data[0]);
            const headerHtml = headers.map(header => 
                `<th>${escapeHtml(header)}</th>`
            ).join('');

            // 행 생성
            const rowsHtml = data.map(row => {
                const cellsHtml = headers.map(header => {
                    const value = row[header];
                    return `<td>${formatCellValue(value)}</td>`;
                }).join('');
                return `<tr>${cellsHtml}</tr>`;
            }).join('');

            return `
                <table>
                    <thead>
                        <tr>${headerHtml}</tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            `;
        }

        // 셀 값 포맷팅
        function formatCellValue(value) {
            if (value === null || value === undefined) {
                return '<em style="color: #999;">NULL</em>';
            }
            
            if (typeof value === 'number') {
                // 숫자는 천 단위 구분자 추가
                return value.toLocaleString();
            }
            
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                // 날짜 형식 감지 및 포맷팅
                try {
                    const date = new Date(value);
                    return date.toLocaleDateString('ko-KR');
                } catch (e) {
                    return escapeHtml(value);
                }
            }
            
            return escapeHtml(String(value));
        }

        // 오류 표시
        function displayError(errorMessage) {
            const errorHtml = `
                <div class="error">
                    <h3>❌ 오류 발생</h3>
                    <p>${escapeHtml(errorMessage)}</p>
                    <p><small>서버 로그를 확인하거나 다른 질문을 시도해보세요.</small></p>
                </div>
            `;

            resultsSection.innerHTML = errorHtml;
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 예시 질문 자동 완성
        const exampleQuestions = [
            "오늘 총 이벤트 수를 알려주세요",
            "가장 인기 있는 이벤트 유형을 보여주세요",
            "국가별 사용자 분포를 보여주세요",
            "모바일 사용자 비율을 알려주세요",
            "시간대별 활동량을 보여주세요",
            "구매 관련 이벤트를 분석해주세요",
            "트래픽 소스별 성과를 보여주세요",
            "운영체제별 사용자 현황을 알려주세요"
        ];

        // 질문 입력창 포커스 시 예시 표시
        questionInput.addEventListener('focus', function() {
            if (!this.value) {
                this.placeholder = exampleQuestions[Math.floor(Math.random() * exampleQuestions.length)];
            }
        });

        // 페이지 로드 시 질문 입력창에 포커스
        window.addEventListener('load', function() {
            questionInput.focus();
        });
    </script>
</body>
</html>